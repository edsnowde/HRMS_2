name: CI / Build & Deploy to GKE

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      IMAGE_BACKEND: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/auralis-repo/auralis-api
      IMAGE_WORKER: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/auralis-repo/auralis-worker
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT }}
          export_default_credentials: true

      - name: Configure Docker auth for Artifact Registry
        run: |
          gcloud --quiet auth configure-docker us-central1-docker.pkg.dev

      - name: Build backend image
        run: |
          docker build -f backend/docker/Dockerfile.api -t $IMAGE_BACKEND:latest backend
      - name: Push backend image
        run: |
          docker push $IMAGE_BACKEND:latest

      - name: Build worker image
        run: |
          docker build -f backend/docker/Dockerfile.worker -t $IMAGE_WORKER:latest backend
      - name: Push worker image
        run: |
          docker push $IMAGE_WORKER:latest

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER }}
          location: ${{ secrets.GKE_ZONE }}
          project_id: ${{ secrets.GCP_PROJECT }}

      - name: Deploy to GKE (apply manifests then set images)
        run: |
          # Ensure secrets and manifests are applied first
          kubectl apply -f k8s/secret-template.yaml || true
          kubectl apply -f k8s/api-deployment.yaml
          kubectl apply -f k8s/worker-deployment.yaml
          kubectl apply -f k8s/service-api.yaml || true
          # Then update images to the built images
          kubectl set image deployment/auralis-api auralis-api=$IMAGE_BACKEND:latest --record
          kubectl set image deployment/auralis-worker auralis-worker=$IMAGE_WORKER:latest --record

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/auralis-api --timeout=120s
          kubectl rollout status deployment/auralis-worker --timeout=120s

